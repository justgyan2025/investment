{% extends "base.html" %}

{% block content %}
<!-- Add Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
    /* Fix for mobile navbar */
    @media (max-width: 640px) {
        .mobile-menu {
            display: block !important; /* Override any !important hiding */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            z-index: 2000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(100%);
        }
        
        .mobile-menu.show {
            transform: translateX(0);
        }
        
        /* Hide mobile menu by default but allow it to be shown when toggled */
        .mobile-menu:not(.show) {
            transform: translateX(100%);
            display: block !important;
        }
        
        /* Ensure mobile menu button remains visible */
        .mobile-menu-button {
            display: flex !important;
            z-index: 2001; /* Higher than mobile menu */
        }
    }
</style>

<div class="py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-semibold text-gray-900">National Pension System (NPS)</h1>
        </div>

        <!-- Portfolio Summary Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <img src="/static/images/nps.png" alt="NPS" class="w-10 h-10 mr-3 rounded-full border border-gray-200 shadow-sm">
                Portfolio Summary
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Investment Card -->
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6 transform transition-all duration-300 hover:scale-105 hover:shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 rounded-full bg-indigo-100 flex items-center justify-center">
                            <i class="fas fa-wallet text-indigo-600 text-xl"></i>
                    </div>
                        <span class="text-sm font-medium text-indigo-600">Total Investment</span>
                    </div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-bold text-indigo-900">₹<span id="totalNPSInvestment">0</span></span>
                        
                </div>
            </div>

                <!-- Current Value Card -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 transform transition-all duration-300 hover:scale-105 hover:shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 rounded-full bg-green-100 flex items-center justify-center">
                            <i class="fas fa-chart-line text-green-600 text-xl"></i>
        </div>
                        <span class="text-sm font-medium text-green-600">Current Value</span>
    </div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-bold text-green-900">₹<span id="currentNPSValue">0</span></span>
                      
                                    </div>
                                                </div>

                <!-- Returns Card -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 transform transition-all duration-300 hover:scale-105 hover:shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-hand-holding-usd text-blue-600 text-xl"></i>
                                    </div>
                        <span class="text-sm font-medium text-blue-600">Total Returns</span>
                                </div>
                    <div class="flex flex-col">
                        <div class="flex items-baseline">
                            <span class="text-2xl font-bold text-blue-900">₹<span id="totalNPSReturns">0</span></span>
                         
                                    </div>
                        <div class="mt-1">
                            <span class="text-lg font-semibold text-blue-900"><span id="totalNPSReturnsPercentage">0</span>%</span>
                            
                                    </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NPS Holdings Table -->
        <div class="mt-8">
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        NPS Holdings
                    </h3>
                    
                    <!-- Add Refresh Button -->
                    <div class="mt-4 flex justify-end">
                        <button id="refreshNPSBtn" class="bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-green-700 transition duration-300 ease-in-out flex items-center">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            Refresh NAV
                        </button>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="mt-4 border-b border-gray-200">
                        <nav class="-mb-px flex" aria-label="Tabs">
                            <button id="tier1Tab" class="tab-button border-indigo-500 text-indigo-600 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                                Tier 1 Investment
                            </button>
                            <button id="tier2Tab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                                Tier 2 Investment
                            </button>
                        </nav>
                    </div>
                    
                    <!-- Tier 1 Content -->
                    <div id="tier1Content" class="tab-content mt-6">
                        <!-- Tier 1 Summary Card -->
                        <div class="tier-summary-card tier1-summary-card bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="tier-summary-header bg-gradient-to-r from-indigo-500 to-indigo-600 p-4">
                                <div class="flex justify-between items-center">
                                    <h4 class="text-lg font-semibold text-white">Tier 1 Summary</h4>
                                </div>
                            </div>
                            <div class="tier-summary-content p-4">
                                <div class="tier-summary-grid grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="tier-summary-item bg-indigo-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-indigo-600">Total Investment</span>
                                        <div class="tier-summary-edit flex items-center justify-between mt-2">
                                            <span class="tier-summary-value text-xl font-bold text-indigo-900">₹<span id="tier1TotalInvestment">0</span></span>
                                            <button id="editTier1InvestmentBtn" class="p-2 text-indigo-600 hover:text-indigo-800 transition-colors rounded-full hover:bg-indigo-50">
                                                <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                    <div class="tier-summary-item bg-indigo-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-indigo-600">Current Value</span>
                                        <span class="tier-summary-value text-xl font-bold text-indigo-900 block mt-2">₹<span id="tier1CurrentValue">0</span></span>
                                </div>
                                    <div class="tier-summary-item bg-indigo-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-indigo-600">Returns</span>
                                        <span class="tier-summary-value text-xl font-bold text-indigo-900 block mt-2">₹<span id="tier1Returns">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Toggle Header for Tier 1 -->
                        <div class="tier-header-mobile block md:hidden">
                            <h3 class="text-lg font-semibold">Tier 1 Investments</h3>
                            <button id="tier1MobileToggle" class="text-white flex items-center">
                                <span id="tier1ToggleText">Show</span>
                                <i id="tier1ToggleIcon" class="fas fa-chevron-down ml-2"></i>
                            </button>
                        </div>

                        <!-- Tier 1 Holdings Table -->
                        <div class="table-view hidden md:block mt-6">
                                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                                        <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheme Name</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current NAV</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Value</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tier1Holdings" class="bg-white divide-y divide-gray-200">
                                                    <!-- Tier 1 holdings will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Mobile Card View -->
                        <div id="tier1MobileHoldings" class="mobile-card-view block md:hidden hidden">
                            <!-- Tier 1 mobile cards will be populated here -->
                        </div>
                        
                        <!-- Add New Tier 1 Fund Form (moved below the table and made minimizable) -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden mt-6">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" id="tier1FormToggle">
                                <h3 class="text-lg font-medium text-gray-900">Add New Tier 1 Fund</h3>
                                <button class="inline-flex items-center px-3 py-2 border border-transparent rounded-md text-sm font-medium text-indigo-600 bg-indigo-100 hover:bg-indigo-200">
                                    <i class="fas fa-chevron-down mr-2 toggle-icon" id="tier1FormToggleIcon"></i>
                                    <span class="toggle-text" id="tier1FormToggleText">Show</span>
                                </button>
                            </div>
                            <div id="tier1FormContainer" class="p-6 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="tier1SchemeCode">Scheme Code</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="tier1SchemeCode" placeholder="Enter Scheme Code" class="w-full">
                                        <button id="tier1FetchBtn" class="fetch-button">Fetch</button>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="tier1Units">Number of Units</label>
                                    <input type="number" id="tier1Units" placeholder="Number of Units" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <div id="tier1SchemeDetails" class="scheme-info mt-4" style="display: none;">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Scheme Name</p>
                                        <p id="tier1SchemeName" class="text-base font-semibold">Waiting...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Current NAV</p>
                                        <p id="tier1CurrentNav" class="text-base font-semibold">Waiting...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button id="tier1AddFundBtn" class="add-fund-button bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">Add Fund</button>
                                </div>
                            </div>
                            </div>
                        </div>
                        
                    <!-- Tier 2 Content -->
                    <div id="tier2Content" class="tab-content mt-6 hidden">
                        <!-- Tier 2 Summary Card -->
                        <div class="tier-summary-card tier2-summary-card bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="tier-summary-header bg-gradient-to-r from-green-500 to-green-600 p-4">
                                <div class="flex justify-between items-center">
                                    <h4 class="text-lg font-semibold text-white">Tier 2 Summary</h4>
                                </div>
                            </div>
                            <div class="tier-summary-content p-4">
                                <div class="tier-summary-grid grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="tier-summary-item bg-green-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-green-600">Total Investment</span>
                                        <div class="tier-summary-edit flex items-center justify-between mt-2">
                                            <span class="tier-summary-value text-xl font-bold text-green-900">₹<span id="tier2TotalInvestment">0</span></span>
                                            <button id="editTier2InvestmentBtn" class="p-2 text-green-600 hover:text-green-800 transition-colors rounded-full hover:bg-green-50">
                                                <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                    <div class="tier-summary-item bg-green-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-green-600">Current Value</span>
                                        <span class="tier-summary-value text-xl font-bold text-green-900 block mt-2">₹<span id="tier2CurrentValue">0</span></span>
                                </div>
                                    <div class="tier-summary-item bg-green-50 rounded-lg p-4 transform transition-all duration-300 hover:scale-105">
                                        <span class="tier-summary-label text-sm font-medium text-green-600">Returns</span>
                                        <span class="tier-summary-value text-xl font-bold text-green-900 block mt-2">₹<span id="tier2Returns">0</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Toggle Header for Tier 2 -->
                        <div class="tier-header-mobile tier2-header-mobile block md:hidden">
                            <h3 class="text-lg font-semibold">Tier 2 Investments</h3>
                            <button id="tier2MobileToggle" class="text-white flex items-center">
                                <span id="tier2ToggleText">Show</span>
                                <i id="tier2ToggleIcon" class="fas fa-chevron-down ml-2"></i>
                            </button>
                        </div>

                        <!-- Tier 2 Holdings Table -->
                        <div class="table-view hidden md:block mt-6">
                                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                                        <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg">
                                            <table class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-50">
                                                    <tr>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scheme Name</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current NAV</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Value</th>
                                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tier2Holdings" class="bg-white divide-y divide-gray-200">
                                                    <!-- Tier 2 holdings will be populated here -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <!-- Mobile Card View -->
                        <div id="tier2MobileHoldings" class="mobile-card-view block md:hidden hidden">
                            <!-- Tier 2 mobile cards will be populated here -->
                    </div>
                    
                        <!-- Add New Tier 2 Fund Form (moved below the table and made minimizable) -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden mt-6">
                            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" id="tier2FormToggle">
                                <h3 class="text-lg font-medium text-gray-900">Add New Tier 2 Fund</h3>
                                <button class="inline-flex items-center px-3 py-2 border border-transparent rounded-md text-sm font-medium text-green-600 bg-green-100 hover:bg-green-200">
                                    <i class="fas fa-chevron-down mr-2 toggle-icon" id="tier2FormToggleIcon"></i>
                                    <span class="toggle-text" id="tier2FormToggleText">Show</span>
                                        </button>
                                    </div>
                            <div id="tier2FormContainer" class="p-6 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="input-group">
                                    <label for="tier2SchemeCode">Scheme Code</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="tier2SchemeCode" placeholder="Enter Scheme Code" class="w-full">
                                        <button id="tier2FetchBtn" class="fetch-button">Fetch</button>
                                    </div>
                                </div>
                                
                                <div class="input-group">
                                    <label for="tier2Units">Number of Units</label>
                                    <input type="number" id="tier2Units" placeholder="Number of Units" min="0" step="0.01">
                                </div>
                            </div>
                            
                            <div id="tier2SchemeDetails" class="scheme-info mt-4" style="display: none;">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Scheme Name</p>
                                        <p id="tier2SchemeName" class="text-base font-semibold">Waiting...</p>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Current NAV</p>
                                        <p id="tier2CurrentNav" class="text-base font-semibold">Waiting...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button id="tier2AddFundBtn" class="add-fund-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Add Fund</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add NPS Modal -->
<div id="addNPSModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Add New NPS Scheme
                        </h3>
                        <div class="mt-4">
                            <label for="schemeCode" class="block text-sm font-medium text-gray-700">Scheme Code</label>
                            <input type="text" name="schemeCode" id="schemeCode" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                        <div class="mt-4">
                            <label for="accountTier" class="block text-sm font-medium text-gray-700">Account Tier</label>
                            <select id="accountTier" name="accountTier" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="1">Tier 1</option>
                                <option value="2">Tier 2</option>
                            </select>
                        </div>
                        <div class="mt-4">
                            <label for="units" class="block text-sm font-medium text-gray-700">Units</label>
                            <input type="number" name="units" id="units" step="0.01" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                        <div class="mt-4">
                            <label for="avgPrice" class="block text-sm font-medium text-gray-700">Average Price</label>
                            <input type="number" name="avgPrice" id="avgPrice" step="0.01" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="saveNPSBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Save
                </button>
                <button type="button" id="cancelNPSBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Remove view toggle styles since we're not using them anymore */
    .view-toggle,
    .view-toggle-btn,
    .view-toggle-btn:hover,
    .view-toggle-btn.active {
        display: none;
    }

    /* Update mobile card view styles for better mobile experience */
    .mobile-card-view {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        padding: 1rem;
    }

    /* Improved mobile card styles */
    .nps-mobile-card {
        background-color: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
        border-left: 4px solid #4f46e5;
        margin-bottom: 0.5rem;
    }

    .nps-mobile-card-content {
        padding: 1rem;
    }

    .nps-mobile-card-header {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .nps-mobile-card-title {
        font-weight: 600;
        font-size: 1rem;
        color: #111827;
    }

    .nps-mobile-card-details {
        margin-bottom: 0.75rem;
    }

    .nps-mobile-card-item {
        display: flex;
        justify-content: space-between;
        padding: 0.375rem 0;
        border-bottom: 1px dashed #e5e7eb;
    }

    .nps-mobile-card-label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .nps-mobile-card-value {
        font-size: 0.875rem;
        font-weight: 500;
        color: #1f2937;
    }

    .nps-mobile-card-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 0.75rem;
    }

    /* Toggle button styles */
    .mobile-toggle-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 0.5rem;
        background-color: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4b5563;
        margin: 0.5rem 0;
        transition: all 0.2s ease;
    }

    .mobile-toggle-btn:hover {
        background-color: #e5e7eb;
    }

    .mobile-toggle-btn i {
        margin-right: 0.5rem;
        transition: transform 0.3s ease;
    }

    .mobile-toggle-btn.expanded i {
        transform: rotate(180deg);
    }

    .tier-header-mobile {
        background: linear-gradient(to right, #4f46e5, #7c3aed);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem 0.5rem 0 0;
        margin-top: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tier2-header-mobile {
        background: linear-gradient(to right, #059669, #10b981);
    }

    /* Add animation for cards */
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .nps-mobile-card {
        animation: slideIn 0.3s ease forwards;
    }

    @media (min-width: 768px) {
        .mobile-card-view {
            display: none;
        }
        .mobile-toggle-view {
            display: none;
        }
    }

    @media (max-width: 767px) {
        .table-view {
            display: none;
        }
        .tier-summary-card {
            margin-bottom: 1rem;
        }
        .tier-summary-grid {
            gap: 0.5rem;
        }
        .tier-summary-item {
            padding: 0.75rem;
        }
    }
</style>

<script>
// Add mobile menu toggle functionality specifically for NPS page
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuButton = document.querySelector('.mobile-menu-button');
    const mobileMenu = document.querySelector('.mobile-menu');
    
    if (mobileMenuButton && mobileMenu) {
        // Make sure we can see the mobile menu button
        mobileMenuButton.style.display = 'flex';
        
        mobileMenuButton.addEventListener('click', function() {
            mobileMenu.classList.toggle('show');
            document.body.classList.toggle('mobile-menu-open');
            mobileMenuButton.classList.toggle('active');
        });
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            if (mobileMenu.classList.contains('show') && 
                !mobileMenu.contains(event.target) && 
                !mobileMenuButton.contains(event.target)) {
                mobileMenu.classList.remove('show');
                document.body.classList.remove('mobile-menu-open');
                mobileMenuButton.classList.remove('active');
            }
        });
        
        // Close button within mobile menu
        const closeButton = document.querySelector('.mobile-menu-close');
        if (closeButton) {
            closeButton.addEventListener('click', function() {
                mobileMenu.classList.remove('show');
                document.body.classList.remove('mobile-menu-open');
                mobileMenuButton.classList.remove('active');
            });
        }
    }
});

// Initialize Firebase
const db = firebase.firestore();

// Tab elements
const tier1Tab = document.getElementById('tier1Tab');
const tier2Tab = document.getElementById('tier2Tab');
const tier1Content = document.getElementById('tier1Content');
const tier2Content = document.getElementById('tier2Content');

// Tab switching functionality
tier1Tab.addEventListener('click', () => {
    tier1Tab.classList.add('border-indigo-500', 'text-indigo-600');
    tier1Tab.classList.remove('border-transparent', 'text-gray-500');
    tier2Tab.classList.add('border-transparent', 'text-gray-500');
    tier2Tab.classList.remove('border-indigo-500', 'text-indigo-600');
    tier1Content.classList.remove('hidden');
    tier2Content.classList.add('hidden');
});

tier2Tab.addEventListener('click', () => {
    tier2Tab.classList.add('border-indigo-500', 'text-indigo-600');
    tier2Tab.classList.remove('border-transparent', 'text-gray-500');
    tier1Tab.classList.add('border-transparent', 'text-gray-500');
    tier1Tab.classList.remove('border-indigo-500', 'text-indigo-600');
    tier2Content.classList.remove('hidden');
    tier1Content.classList.add('hidden');
});

// Tier 1 form elements
const tier1SchemeCode = document.getElementById('tier1SchemeCode');
const tier1FetchBtn = document.getElementById('tier1FetchBtn');
const tier1SchemeInfo = document.getElementById('tier1SchemeInfo');
const tier1SchemeName = document.getElementById('tier1SchemeName');
const tier1CurrentNav = document.getElementById('tier1CurrentNav');
const tier1Units = document.getElementById('tier1Units');
const tier1SaveBtn = document.getElementById('tier1SaveBtn');
const addTier1InvestmentBtn = document.getElementById('addTier1InvestmentBtn');
const editTier1InvestmentBtn = document.getElementById('editTier1InvestmentBtn');

// Tier 2 form elements
const tier2SchemeCode = document.getElementById('tier2SchemeCode');
const tier2FetchBtn = document.getElementById('tier2FetchBtn');
const tier2SchemeInfo = document.getElementById('tier2SchemeInfo');
const tier2SchemeName = document.getElementById('tier2SchemeName');
const tier2CurrentNav = document.getElementById('tier2CurrentNav');
const tier2Units = document.getElementById('tier2Units');
const tier2SaveBtn = document.getElementById('tier2SaveBtn');
const addTier2InvestmentBtn = document.getElementById('addTier2InvestmentBtn');
const editTier2InvestmentBtn = document.getElementById('editTier2InvestmentBtn');

// Current fetched scheme data
let tier1SchemeData = null;
let tier2SchemeData = null;

// Tier total amounts
let tier1TotalInvestmentAmount = 0;
let tier2TotalInvestmentAmount = 0;
let tier1TotalCurrentValue = 0;
let tier2TotalCurrentValue = 0;

// Edit tier total investment button event listeners
editTier1InvestmentBtn.addEventListener('click', function() {
    console.log("Edit Tier 1 button clicked");
    const tier1Total = parseFloat(window.tier1TotalInvestment || 0);
    console.log("Passing numeric value to editTierTotalInvestment:", tier1Total);
    editTierTotalInvestment('tier1', tier1Total);
});

editTier2InvestmentBtn.addEventListener('click', function() {
    console.log("Edit Tier 2 button clicked");
    const tier2Total = parseFloat(window.tier2TotalInvestment || 0);
    console.log("Passing numeric value to editTierTotalInvestment:", tier2Total);
    editTierTotalInvestment('tier2', tier2Total);
});

// Function to edit the total investment for a tier
async function editTierTotalInvestment(tier, currentAmount) {
    try {
        console.log(`Editing tier ${tier} with current amount:`, currentAmount);
        
        // Ensure we have a number for currentAmount
        let numericAmount = 0;
        
        if (typeof currentAmount === 'number') {
            numericAmount = currentAmount;
        } else if (typeof currentAmount === 'string') {
            numericAmount = parseFloat(currentAmount) || 0;
        } else if (currentAmount && typeof currentAmount === 'object') {
            // If it's a DOM element, try to get its text content
            const textContent = currentAmount.textContent || '0';
            numericAmount = parseFloat(textContent.replace(/[^0-9.-]+/g, '')) || 0;
        } else {
        // Use the global tier investment amount if currentAmount is not a valid number
            if (tier === 'tier1' || tier === 1) {
                numericAmount = parseFloat(window.tier1TotalInvestment) || 0;
                console.log("Using window.tier1TotalInvestment:", numericAmount);
            } else if (tier === 'tier2' || tier === 2) {
                numericAmount = parseFloat(window.tier2TotalInvestment) || 0;
                console.log("Using window.tier2TotalInvestment:", numericAmount);
            } else {
                console.error("Invalid tier parameter:", tier);
                alert("Error: Invalid tier parameter");
                return;
            }
        }
        
        const tierLabel = (tier === 'tier1' || tier === 1) ? 'Tier 1' : 'Tier 2';
        
        // Prompt for new investment amount
        const newAmountStr = prompt(`Edit total ${tierLabel} investment amount:`, numericAmount.toFixed(2));
        
        // Check if user cancelled
        if (newAmountStr === null) {
            return;
        }
        
        // Validate input
        const newAmount = parseFloat(newAmountStr);
        if (isNaN(newAmount) || newAmount < 0) {
            alert('Please enter a valid investment amount.');
            return;
        }
        
        // Standardize tier format for document ID
        const metaDocId = (tier === 'tier1' || tier === 1) ? 'tier1_total' : 'tier2_total';
        
        const userId = firebase.auth().currentUser.uid;
        console.log(`Updating metadata document: ${metaDocId} for user: ${userId}`);
        const metaRef = db.collection('users').doc(userId).collection('nps_metadata').doc(metaDocId);
        
        // Update the metadata with the new total
        await metaRef.update({
            totalInvestment: newAmount,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Calculate the change in total investment
        const difference = newAmount - numericAmount;
        console.log(`Investment change: ${difference} (${numericAmount} → ${newAmount})`);
        
        // Update the user's total investment
        if (difference !== 0) {
            const userRef = db.collection('users').doc(userId);
            await userRef.update({
                totalInvestment: firebase.firestore.FieldValue.increment(difference)
            });
        }
        
        alert(`${tierLabel} total investment updated successfully.`);
        
        // Refresh the display
        updateNPSHoldings();
        
    } catch (error) {
        console.error('Error updating total investment:', error);
        console.log('Error details:', error.message, error.code);
        alert(`Error updating total investment: ${error.message}`);
    }
}

// Function to fetch scheme details
async function fetchSchemeDetails(tier) {
    try {
        const schemeCodeElement = document.getElementById(`${tier}SchemeCode`);
        const schemeCode = schemeCodeElement.value.trim();
        
        if (!schemeCode) {
            alert('Please enter a scheme code.');
            return;
        }
        
        // Show waiting status
        const schemeDetailsElement = document.getElementById(`${tier}SchemeDetails`);
        schemeDetailsElement.style.display = 'block';
        document.getElementById(`${tier}SchemeName`).textContent = 'Fetching...';
        document.getElementById(`${tier}CurrentNav`).textContent = 'Fetching...';
        
        console.log(`Fetching scheme details for code: ${schemeCode}`);
        
        try {
            // Make the API call with proper CORS handling
            const apiUrl = `https://npsnav.in/api/detailed/${schemeCode}`;
            console.log(`API URL: ${apiUrl}`);
            
            // Use a proxy if CORS is an issue or make a direct call
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
                mode: 'cors' // Try with cors mode first
            });
            
            if (!response.ok) {
                throw new Error(`API returned status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('API response data:', data);
            
            if (!data || !data['Scheme Name'] || !data['NAV']) {
                throw new Error('Invalid API response format');
            }
            
            // Create scheme data object
            const schemeData = {
                scheme_name: data['Scheme Name'],
                current_nav: data['NAV']
            };
            
            console.log(`Processed scheme data:`, schemeData);
            
            // Store the scheme data in the appropriate variable for later use
            if (tier === 'tier1') {
                tier1SchemeData = schemeData;
            } else {
                tier2SchemeData = schemeData;
            }
            
            // Update UI with scheme details
            document.getElementById(`${tier}SchemeName`).textContent = schemeData.scheme_name;
            document.getElementById(`${tier}CurrentNav`).textContent = `₹${schemeData.current_nav}`;
            
        } catch (apiError) {
            console.error('API Error:', apiError);
            
            // Fallback to mocked data for testing if API fails
            console.log('Falling back to mock data for testing');
            const mockData = {
                scheme_name: `NPS ${schemeCode} Scheme`,
                current_nav: (Math.random() * 30 + 20).toFixed(2)
            };
            
            // Store the mock data
            if (tier === 'tier1') {
                tier1SchemeData = mockData;
            } else {
                tier2SchemeData = mockData;
            }
            
            // Update UI with mock data
            document.getElementById(`${tier}SchemeName`).textContent = mockData.scheme_name;
            document.getElementById(`${tier}CurrentNav`).textContent = `₹${mockData.current_nav}`;
            
            // Show warning about using mock data
            alert(`Could not fetch real data: ${apiError.message}. Using sample data for testing.`);
        }
    } catch (error) {
        console.error(`Error in fetchSchemeDetails for ${tier}:`, error);
        alert('Error fetching scheme details. Please try again.');
        
        // Reset UI on error
        document.getElementById(`${tier}SchemeDetails`).style.display = 'none';
    }
}

// Calculate investment amount from units and NAV
function calculateInvestmentAmount(units, currentNav) {
    if (!units || !currentNav || units <= 0 || currentNav <= 0) {
        return 0;
    }
    return units * currentNav;
}

// Common function to validate form data
function validateFormData(schemeData, units, tierPrefix) {
    if (!schemeData) {
        alert('Please fetch scheme details first');
        return false;
    }
    
    if (!units || isNaN(units) || units <= 0) {
        alert('Please enter a valid number of units');
        document.getElementById(`${tierPrefix}Units`).focus();
        return false;
    }
    
    return true;
}

// Fetch button click handlers
tier1FetchBtn.addEventListener('click', () => {
    fetchSchemeDetails('tier1');
});

tier2FetchBtn.addEventListener('click', () => {
    fetchSchemeDetails('tier2');
});

// Function to update NPS holdings from Firestore
async function updateNPSHoldings() {
    try {
        console.log("Starting updateNPSHoldings function");
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) {
            console.error("No authenticated user found");
            return;
        }
        
        // Clear tables first - ensure there's no stale data
        document.getElementById('tier1Holdings').innerHTML = '';
        document.getElementById('tier2Holdings').innerHTML = '';
        document.getElementById('tier1MobileHoldings').innerHTML = '';
        document.getElementById('tier2MobileHoldings').innerHTML = '';
        
        // Fetch holdings and metadata
        const npsRef = db.collection('users').doc(userId).collection('nps');
        const tier1MetaRef = db.collection('users').doc(userId).collection('nps_metadata').doc('tier1_total');
        const tier2MetaRef = db.collection('users').doc(userId).collection('nps_metadata').doc('tier2_total');
        
        // Get all data in a single batch
        const [snapshot, tier1MetaDoc, tier2MetaDoc] = await Promise.all([
            npsRef.orderBy('timestamp', 'desc').get(), // Order by timestamp descending to get the latest first
            tier1MetaRef.get(),
            tier2MetaRef.get()
        ]);
        
        if (snapshot.empty) {
            console.log("No NPS holdings found");
            const emptyMessage = `
                <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No investments found.</td></tr>
            `;
            document.getElementById('tier1Holdings').innerHTML = emptyMessage;
            document.getElementById('tier2Holdings').innerHTML = emptyMessage;
            document.getElementById('tier1MobileHoldings').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p class="text-lg font-medium">No investments found</p>
                    <p class="text-sm text-gray-400">Add your first investment to get started</p>
                </div>
            `;
            document.getElementById('tier2MobileHoldings').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p class="text-lg font-medium">No investments found</p>
                    <p class="text-sm text-gray-400">Add your first investment to get started</p>
                </div>
            `;
            
            // Reset all summary values to 0
            document.getElementById('tier1TotalInvestment').textContent = '0';
            document.getElementById('tier1CurrentValue').textContent = '0';
            document.getElementById('tier1Returns').textContent = '0';
            document.getElementById('tier2TotalInvestment').textContent = '0';
            document.getElementById('tier2CurrentValue').textContent = '0';
            document.getElementById('tier2Returns').textContent = '0';
            document.getElementById('totalNPSInvestment').textContent = '0';
            document.getElementById('currentNPSValue').textContent = '0';
            document.getElementById('totalNPSReturns').textContent = '0';
            
            return;
        }
        
        console.log(`Processing ${snapshot.docs.length} documents`);
        
        // Create objects to store unique funds with Map keyed by scheme_code+tier
        const uniqueFunds = new Map();
        
        // First pass: identify all documents by scheme_code+tier combination
        snapshot.docs.forEach(doc => {
                const data = doc.data();
            if (!data || !data.scheme_code || !data.tier) {
                console.warn(`Invalid document data in ${doc.id}`);
                return;
            }
                
                const schemeCode = data.scheme_code;
            const tier = data.tier;
            // Create a unique key that combines scheme code and tier
            const uniqueKey = `${schemeCode}_${tier}`;
                
            // If this key already exists and we've already processed a document for it, skip
            if (uniqueFunds.has(uniqueKey)) {
                console.log(`Skipping duplicate for ${uniqueKey}`);
                    return;
                }
                
                const units = parseFloat(data.units || 0);
            const currentNav = parseFloat(data.current_nav || 0);
            const investment = parseFloat(data.investment || 0);
            
            if (isNaN(units) || isNaN(currentNav) || isNaN(investment)) {
                console.warn(`Invalid numeric values in document ${doc.id}`);
                return;
            }
            
            const currentValue = units * currentNav;
            
            // Add to uniqueFunds Map with our combined key
            uniqueFunds.set(uniqueKey, {
                ...data,
                units,
                currentNav,
                investment,
                currentValue,
                schemeCode,
                tier,
                docId: doc.id
            });
        });
        
        console.log(`Found ${uniqueFunds.size} unique fund entries`);
        
        // Calculate total investment values from metadata
        let tier1TotalInvestment = tier1MetaDoc.exists ? parseFloat(tier1MetaDoc.data().totalInvestment || 0) : 0;
        let tier2TotalInvestment = tier2MetaDoc.exists ? parseFloat(tier2MetaDoc.data().totalInvestment || 0) : 0;
        
        // Calculate current values from unique funds
        let tier1TotalCurrentValue = 0;
        let tier2TotalCurrentValue = 0;
        
        // Create separate Maps for tier1 and tier2 (for rendering)
        const tier1Funds = new Map();
        const tier2Funds = new Map();
        
        // Populate tier-specific Maps and calculate totals
        uniqueFunds.forEach((fund, key) => {
            if (fund.tier === 'tier1') {
                tier1TotalCurrentValue += fund.currentValue;
                tier1Funds.set(fund.schemeCode, fund);
            } else if (fund.tier === 'tier2') {
                tier2TotalCurrentValue += fund.currentValue;
                tier2Funds.set(fund.schemeCode, fund);
            }
        });
        
        console.log(`Tier 1 unique funds: ${tier1Funds.size}, total value: ${tier1TotalCurrentValue}`);
        console.log(`Tier 2 unique funds: ${tier2Funds.size}, total value: ${tier2TotalCurrentValue}`);
        
        // Calculate returns for each tier
        const tier1Returns = tier1TotalCurrentValue - tier1TotalInvestment;
        const tier2Returns = tier2TotalCurrentValue - tier2TotalInvestment;
        
        // Calculate portfolio totals
        const totalInvestment = tier1TotalInvestment + tier2TotalInvestment;
        const totalCurrentValue = tier1TotalCurrentValue + tier2TotalCurrentValue;
        const totalReturns = totalCurrentValue - totalInvestment;
        const totalReturnsPercentage = totalInvestment > 0 ? (totalReturns / totalInvestment) * 100 : 0;
        
        // Update Tier 1 summary with animation
        animateValue('tier1TotalInvestment', tier1TotalInvestment.toFixed(2));
        animateValue('tier1CurrentValue', tier1TotalCurrentValue.toFixed(2));
        animateValue('tier1Returns', tier1Returns.toFixed(2));
        
        // Update Tier 2 summary with animation
        animateValue('tier2TotalInvestment', tier2TotalInvestment.toFixed(2));
        animateValue('tier2CurrentValue', tier2TotalCurrentValue.toFixed(2));
        animateValue('tier2Returns', tier2Returns.toFixed(2));
        
        // Update portfolio summary with animation
        animateValue('totalNPSInvestment', totalInvestment.toFixed(2));
        animateValue('currentNPSValue', totalCurrentValue.toFixed(2));
        animateValue('totalNPSReturns', totalReturns.toFixed(2));
        animateValue('totalNPSReturnsPercentage', totalReturnsPercentage.toFixed(2));
        
        // Render tables for both tiers
        renderTier1Table(tier1Funds);
        renderTier2Table(tier2Funds);
        
        console.log("Completed updateNPSHoldings function");
    } catch (error) {
        console.error('Error updating NPS holdings:', error);
        alert(`Error loading NPS holdings: ${error.message}`);
    }
}

// Function to render Tier 1 table and mobile view
function renderTier1Table(tier1Funds) {
    const tier1TableBody = document.getElementById('tier1Holdings');
    const tier1MobileContainer = document.getElementById('tier1MobileHoldings');
    
    // Clear any existing content
    tier1TableBody.innerHTML = '';
    tier1MobileContainer.innerHTML = '';
    
    if (tier1Funds.size === 0) {
        tier1TableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No investments found.</td></tr>`;
        tier1MobileContainer.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <p class="text-lg font-medium">No investments found</p>
                <p class="text-sm text-gray-400">Add your first investment to get started</p>
            </div>
        `;
        return;
    }
    
    // Render Tier 1 holdings
    tier1Funds.forEach((holding, schemeCode) => {
        const returns = holding.currentValue - holding.investment;
        const returnsPercentage = holding.investment > 0 ? (returns / holding.investment) * 100 : 0;
        
        // Generate table row
        const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${holding.scheme_name || 'Unknown Scheme'}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ₹${formatIndianNumber(holding.currentNav.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatIndianNumber(holding.units.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ₹${formatIndianNumber(holding.currentValue.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button class="btn-edit-nps text-blue-600 hover:text-blue-900 mr-2" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-units="${holding.units}" data-multiple="false">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                <button class="btn-delete-nps text-red-600 hover:text-red-900" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-multiple="false">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                        </td>
                    `;
        tier1TableBody.appendChild(row);
        
        // Generate mobile card
        const card = document.createElement('div');
        card.className = 'nps-mobile-card';
        card.innerHTML = `
            <div class="nps-mobile-card-content">
                <div class="nps-mobile-card-header">
                    <h4 class="nps-mobile-card-title">${holding.scheme_name || 'Unknown Scheme'}</h4>
                    <div class="text-xs text-indigo-600 font-medium">${schemeCode}</div>
                </div>
                <div class="nps-mobile-card-details">
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Current NAV</span>
                        <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.currentNav.toFixed(2))}</span>
                    </div>
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Units</span>
                        <span class="nps-mobile-card-value">${formatIndianNumber(holding.units.toFixed(2))}</span>
                    </div>
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Current Value</span>
                        <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.currentValue.toFixed(2))}</span>
                    </div>
                </div>
                <div class="nps-mobile-card-actions">
                    <button class="btn-edit-nps text-blue-600 hover:text-blue-900 mr-2 px-3 py-1 rounded-md hover:bg-blue-50" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-units="${holding.units}" data-multiple="false">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button class="btn-delete-nps text-red-600 hover:text-red-900 px-3 py-1 rounded-md hover:bg-red-50" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-multiple="false">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </div>
        `;
        tier1MobileContainer.appendChild(card);
        
        // Add animation for new cards
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 50);
    });
}

// Function to render Tier 2 table and mobile view
function renderTier2Table(tier2Funds) {
    const tier2TableBody = document.getElementById('tier2Holdings');
    const tier2MobileContainer = document.getElementById('tier2MobileHoldings');
    
    // Clear any existing content
    tier2TableBody.innerHTML = '';
    tier2MobileContainer.innerHTML = '';
    
    if (tier2Funds.size === 0) {
        tier2TableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No investments found.</td></tr>`;
        tier2MobileContainer.innerHTML = `
            <div class="text-center text-gray-500 py-8">
                <p class="text-lg font-medium">No investments found</p>
                <p class="text-sm text-gray-400">Add your first investment to get started</p>
            </div>
        `;
        return;
    }
    
    // Render Tier 2 holdings
    tier2Funds.forEach((holding, schemeCode) => {
        const returns = holding.currentValue - holding.investment;
        const returnsPercentage = holding.investment > 0 ? (returns / holding.investment) * 100 : 0;
        
        // Generate table row
        const row = document.createElement('tr');
                    row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${holding.scheme_name || 'Unknown Scheme'}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ₹${formatIndianNumber(holding.currentNav.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatIndianNumber(holding.units.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ₹${formatIndianNumber(holding.currentValue.toFixed(2))}
                        </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <button class="btn-edit-nps text-blue-600 hover:text-blue-900 mr-2" data-id="${holding.docId}" data-tier="tier2" data-scheme="${schemeCode}" data-units="${holding.units}" data-multiple="false">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                <button class="btn-delete-nps text-red-600 hover:text-red-900" data-id="${holding.docId}" data-tier="tier2" data-scheme="${schemeCode}" data-multiple="false">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                        </td>
                    `;
        tier2TableBody.appendChild(row);
        
        // Generate mobile card
        const card = document.createElement('div');
        card.className = 'nps-mobile-card';
        card.innerHTML = `
            <div class="nps-mobile-card-content">
                <div class="nps-mobile-card-header">
                    <h4 class="nps-mobile-card-title">${holding.scheme_name || 'Unknown Scheme'}</h4>
                    <div class="text-xs text-green-600 font-medium">${schemeCode}</div>
                </div>
                <div class="nps-mobile-card-details">
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Current NAV</span>
                        <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.currentNav.toFixed(2))}</span>
                    </div>
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Units</span>
                        <span class="nps-mobile-card-value">${formatIndianNumber(holding.units.toFixed(2))}</span>
                    </div>
                    <div class="nps-mobile-card-item">
                        <span class="nps-mobile-card-label">Current Value</span>
                        <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.currentValue.toFixed(2))}</span>
                    </div>
                </div>
                <div class="nps-mobile-card-actions">
                    <button class="btn-edit-nps text-blue-600 hover:text-blue-900 mr-2 px-3 py-1 rounded-md hover:bg-blue-50" data-id="${holding.docId}" data-tier="tier2" data-scheme="${schemeCode}" data-units="${holding.units}" data-multiple="false">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button class="btn-delete-nps text-red-600 hover:text-red-900 px-3 py-1 rounded-md hover:bg-red-50" data-id="${holding.docId}" data-tier="tier2" data-scheme="${schemeCode}" data-multiple="false">
                        <i class="fas fa-trash mr-1"></i>Delete
                    </button>
                </div>
            </div>
        `;
        tier2MobileContainer.appendChild(card);
        
        // Add animation for new cards
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 50);
    });
}

// Function to animate value changes
function animateValue(elementId, targetValue, duration = 1000) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = parseFloat(element.textContent) || 0;
    const target = parseFloat(targetValue);
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeProgress = progress < 0.5
            ? 2 * progress * progress
            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
        
        const currentValue = startValue + (target - startValue) * easeProgress;
        
        // Format the value based on whether it's a percentage or currency
        if (elementId === 'totalNPSReturnsPercentage') {
            element.textContent = formatIndianNumber(currentValue.toFixed(2));
        } else {
            element.textContent = formatIndianNumber(currentValue.toFixed(2));
        }
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

// Function to submit a new Tier 1 fund
async function submitTier1Fund() {
    try {
        console.log("Submitting Tier 1 fund...");
        
        // Get form values
        const schemeCode = document.getElementById('tier1SchemeCode').value.trim();
        const units = document.getElementById('tier1Units').value.trim();
        const schemeName = document.getElementById('tier1SchemeName').textContent.trim();
        const currentNav = document.getElementById('tier1CurrentNav').textContent.replace('₹', '').trim();
        
        // Validation
        if (!schemeCode) {
            alert('Please enter a scheme code.');
            return;
        }
        
        if (!schemeName || schemeName === 'Waiting...' || schemeName === 'Fetching...') {
            alert('Please fetch scheme details first.');
            return;
        }
        
        if (!units || isNaN(parseFloat(units)) || parseFloat(units) <= 0) {
            alert('Please enter a valid number of units.');
            return;
        }
        
        // Parse values
        const unitsValue = parseFloat(units);
        const navValue = parseFloat(currentNav);
        const investmentValue = unitsValue * navValue;
        
        // Get user ID
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) {
            alert('You must be logged in to add funds.');
            return;
        }
        
        // Disable the add button to prevent multiple submissions
        const addButton = document.getElementById('tier1AddFundBtn');
        const originalButtonText = addButton.innerHTML;
        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        try {
            // Check for existing document with the same scheme code in tier1
            const npsRef = db.collection('users').doc(userId).collection('nps');
            const query = await npsRef.where('scheme_code', '==', schemeCode)
                                   .where('tier', '==', 'tier1')
                                   .get();
            
            if (!query.empty) {
                // Found existing entries - ask if user wants to update
                const firstDoc = query.docs[0];
                const existingData = firstDoc.data();
                const existingUnits = parseFloat(existingData.units || 0);
                
                if (confirm(`You already have ${schemeName} (${existingUnits.toFixed(2)} units) in your Tier 1 investments. Do you want to add ${unitsValue.toFixed(2)} more units?`)) {
                    // Update units in the first document
                    const docId = firstDoc.id;
                    const newTotalUnits = existingUnits + unitsValue;
                    
                    await npsRef.doc(docId).update({
                        units: newTotalUnits,
                        current_nav: navValue,
                        investment: newTotalUnits * navValue,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log(`Updated ${schemeName} from ${existingUnits.toFixed(2)} to ${newTotalUnits.toFixed(2)} units`);
                    alert(`Updated ${schemeName} to a total of ${newTotalUnits.toFixed(2)} units.`);
                } else {
                    // User chose not to update
                    console.log('Update cancelled by user');
                    alert('Operation cancelled. No changes were made.');
                }
            } else {
                // Create a new document with a unique ID
                const timestamp = Date.now();
                const docId = `${schemeCode}_tier1_${timestamp}`;
                
                await npsRef.doc(docId).set({
                    scheme_code: schemeCode,
                    scheme_name: schemeName,
                    tier: 'tier1',
                    units: unitsValue,
                    current_nav: navValue,
                    investment: investmentValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`Added new Tier 1 fund: ${schemeName}, ${unitsValue} units`);
                alert(`Added ${schemeName} with ${unitsValue.toFixed(2)} units to your Tier 1 investments.`);
            }
            
            // Clear form inputs
            document.getElementById('tier1SchemeCode').value = '';
            document.getElementById('tier1Units').value = '';
            document.getElementById('tier1SchemeDetails').style.display = 'none';
            
            // Reset scheme data
            tier1SchemeData = null;
            
        } catch (error) {
            console.error('Database error:', error);
            alert(`Error: ${error.message}`);
        } finally {
            // Always re-enable the button regardless of outcome
            addButton.disabled = false;
            addButton.innerHTML = originalButtonText;
            
            // Update the display after a slight delay
            setTimeout(() => {
                updateNPSHoldings();
            }, 500);
        }
    } catch (error) {
        console.error('Error in submitTier1Fund:', error);
        alert(`An unexpected error occurred: ${error.message}`);
        
        // Re-enable the button
        const addButton = document.getElementById('tier1AddFundBtn');
        if (addButton) {
            addButton.disabled = false;
            addButton.innerHTML = 'Add Fund';
        }
    }
}

// Function to submit a new Tier 2 fund
async function submitTier2Fund() {
    try {
        console.log("Submitting Tier 2 fund...");
        
        // Get form values
        const schemeCode = document.getElementById('tier2SchemeCode').value.trim();
        const units = document.getElementById('tier2Units').value.trim();
        const schemeName = document.getElementById('tier2SchemeName').textContent.trim();
        const currentNav = document.getElementById('tier2CurrentNav').textContent.replace('₹', '').trim();
        
        // Validation
        if (!schemeCode) {
            alert('Please enter a scheme code.');
            return;
        }
        
        if (!schemeName || schemeName === 'Waiting...' || schemeName === 'Fetching...') {
            alert('Please fetch scheme details first.');
            return;
        }
        
        if (!units || isNaN(parseFloat(units)) || parseFloat(units) <= 0) {
            alert('Please enter a valid number of units.');
            return;
        }
        
        // Parse values
        const unitsValue = parseFloat(units);
        const navValue = parseFloat(currentNav);
        const investmentValue = unitsValue * navValue;
        
        // Get user ID
        const userId = firebase.auth().currentUser?.uid;
        if (!userId) {
            alert('You must be logged in to add funds.');
            return;
        }
        
        // Disable the add button to prevent multiple submissions
        const addButton = document.getElementById('tier2AddFundBtn');
        const originalButtonText = addButton.innerHTML;
        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        try {
            // Check for existing document with the same scheme code in tier2
            const npsRef = db.collection('users').doc(userId).collection('nps');
            const query = await npsRef.where('scheme_code', '==', schemeCode)
                                   .where('tier', '==', 'tier2')
                                   .get();
            
            if (!query.empty) {
                // Found existing entries - ask if user wants to update
                const firstDoc = query.docs[0];
                const existingData = firstDoc.data();
                const existingUnits = parseFloat(existingData.units || 0);
                
                if (confirm(`You already have ${schemeName} (${existingUnits.toFixed(2)} units) in your Tier 2 investments. Do you want to add ${unitsValue.toFixed(2)} more units?`)) {
                    // Update units in the first document
                    const docId = firstDoc.id;
                    const newTotalUnits = existingUnits + unitsValue;
                    
                    await npsRef.doc(docId).update({
                        units: newTotalUnits,
                        current_nav: navValue,
                        investment: newTotalUnits * navValue,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log(`Updated ${schemeName} from ${existingUnits.toFixed(2)} to ${newTotalUnits.toFixed(2)} units`);
                    alert(`Updated ${schemeName} to a total of ${newTotalUnits.toFixed(2)} units.`);
                } else {
                    // User chose not to update
                    console.log('Update cancelled by user');
                    alert('Operation cancelled. No changes were made.');
                }
            } else {
                // Create a new document with a unique ID
                const timestamp = Date.now();
                const docId = `${schemeCode}_tier2_${timestamp}`;
                
                await npsRef.doc(docId).set({
                    scheme_code: schemeCode,
                    scheme_name: schemeName,
                    tier: 'tier2',
                    units: unitsValue,
                    current_nav: navValue,
                    investment: investmentValue,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log(`Added new Tier 2 fund: ${schemeName}, ${unitsValue} units`);
                alert(`Added ${schemeName} with ${unitsValue.toFixed(2)} units to your Tier 2 investments.`);
            }
            
            // Clear form inputs
            document.getElementById('tier2SchemeCode').value = '';
            document.getElementById('tier2Units').value = '';
            document.getElementById('tier2SchemeDetails').style.display = 'none';
            
            // Reset scheme data
            tier2SchemeData = null;
            
        } catch (error) {
            console.error('Database error:', error);
            alert(`Error: ${error.message}`);
        } finally {
            // Always re-enable the button regardless of outcome
            addButton.disabled = false;
            addButton.innerHTML = originalButtonText;
            
            // Update the display after a slight delay
            setTimeout(() => {
                updateNPSHoldings();
            }, 500);
        }
    } catch (error) {
        console.error('Error in submitTier2Fund:', error);
        alert(`An unexpected error occurred: ${error.message}`);
        
        // Re-enable the button
        const addButton = document.getElementById('tier2AddFundBtn');
        if (addButton) {
            addButton.disabled = false;
            addButton.innerHTML = 'Add Fund';
        }
    }
}

// Attach event listeners to edit and delete buttons with event delegation
document.addEventListener('click', function(event) {
    // Check if the clicked element is an edit button or a child of it
    const editButton = event.target.closest('.btn-edit-nps');
    if (editButton) {
        const docId = editButton.getAttribute('data-id');
        const tier = editButton.getAttribute('data-tier');
        const schemeCode = editButton.getAttribute('data-scheme');
        const units = editButton.getAttribute('data-units');
        const isMultiple = editButton.getAttribute('data-multiple') === 'true';
        editNPSUnits(docId, tier, schemeCode, units, isMultiple);
    }
    
    // Check if the clicked element is a delete button or a child of it
    const deleteButton = event.target.closest('.btn-delete-nps');
    if (deleteButton) {
        const docId = deleteButton.getAttribute('data-id');
        const tier = deleteButton.getAttribute('data-tier');
        const schemeCode = deleteButton.getAttribute('data-scheme');
        const isMultiple = deleteButton.getAttribute('data-multiple') === 'true';
        deleteNPS(docId, tier, schemeCode, isMultiple);
    }
});

// Function to edit NPS units
async function editNPSUnits(docId, tier, schemeCode, currentUnits, isMultiple) {
    try {
        // Get the current user ID
        const userId = firebase.auth().currentUser.uid;
        if (!userId) {
            alert('You must be logged in to edit funds.');
            return;
        }
        
        // Reference to the NPS collection
        const npsRef = db.collection('users').doc(userId).collection('nps');
        
        // If this is a multiple entry case, handle specially
        if (isMultiple === 'true' || isMultiple === true) {
            // Get all documents with this scheme code and tier
            const tierValue = tier === 'tier1' ? 'tier1' : 'tier2';
            const query = await npsRef.where('scheme_code', '==', schemeCode)
                                    .where('tier', '==', tierValue)
                                    .get();
            
            if (query.empty) {
                alert('No matching schemes found.');
                return;
            }
            
            // Calculate total units across all documents
            let totalUnits = 0;
            query.forEach(doc => {
                totalUnits += parseFloat(doc.data().units || 0);
            });
            
            // Get the scheme name for the prompt
            const firstDoc = query.docs[0];
            const schemeName = firstDoc.data().scheme_name || schemeCode;
            
            // Prompt for new units with warning about multiple entries
            const promptMessage = `This scheme "${schemeName}" has multiple entries with a total of ${totalUnits.toFixed(2)} units. 
            
Do you want to:
1. Edit all entries at once (recommended)
2. Edit just this specific entry (${parseFloat(currentUnits).toFixed(2)} units)

Enter new units value:`;
            
            const newUnitsStr = prompt(promptMessage, totalUnits.toFixed(2));
            
            // Check if user cancelled
            if (newUnitsStr === null) {
                return;
            }
            
            // Validate input
            const newUnits = parseFloat(newUnitsStr);
            if (isNaN(newUnits) || newUnits < 0) {
                alert('Please enter a valid number of units.');
                return;
            }
            
            // Ask user which option they chose
            const editOption = prompt('Which option did you choose? (1 for all entries, 2 for just this entry)', '1');
            
            if (editOption === '1') {
                // Calculate the ratio to distribute new units proportionally
                const ratio = newUnits / totalUnits;
                
                // Use a batch for multiple updates
                const batch = db.batch();
                
                query.forEach(doc => {
                    const docUnits = parseFloat(doc.data().units || 0);
                    const newDocUnits = docUnits * ratio;
                    batch.update(doc.ref, { 
                        units: newDocUnits,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                // Commit the batch
                await batch.commit();
                alert(`Successfully updated all entries of ${schemeName} to a total of ${newUnits.toFixed(2)} units.`);
            } else {
                // Edit just the one entry
                const docRef = npsRef.doc(docId);
                await docRef.update({
                    units: newUnits,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert(`Updated one entry of ${schemeName} to ${newUnits.toFixed(2)} units.`);
            }
        } else {
            // This is a single entry case - simpler flow
            const docRef = npsRef.doc(docId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('Fund not found.');
                return;
            }
            
            const data = doc.data();
            const schemeName = data.scheme_name || 'this scheme';
            const tierLabel = tier === 'tier1' ? 'Tier 1' : 'Tier 2';
            
            // Prompt for new units
            const newUnitsStr = prompt(`Edit units for ${schemeName} (${tierLabel}):`, parseFloat(currentUnits).toFixed(2));
            
            // Check if user cancelled
            if (newUnitsStr === null) {
                return;
            }
            
            // Validate input
            const newUnits = parseFloat(newUnitsStr);
            if (isNaN(newUnits) || newUnits < 0) {
                alert('Please enter a valid number of units.');
                return;
            }
            
            // Show loading state on the edit button
            const buttons = document.querySelectorAll(`.btn-edit-nps[data-id="${docId}"]`);
            buttons.forEach(button => {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Updating...';
            });
            
            // Update the document
            await docRef.update({
                units: newUnits,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Show success message
            alert(`Successfully updated ${schemeName} to ${newUnits.toFixed(2)} units.`);
        }
        
        // Update the display
        updateNPSHoldings();
        
    } catch (error) {
        console.error('Error editing NPS units:', error);
        alert(`Error editing NPS units: ${error.message}. Please try again.`);
        
        // Reset buttons in case of error
        const buttons = document.querySelectorAll(`.btn-edit-nps[data-id="${docId}"]`);
        buttons.forEach(button => {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-edit mr-1"></i>Edit';
        });
    }
}

// Function to delete NPS scheme
async function deleteNPS(docId, tier, schemeCode, isMultiple) {
    try {
        // Get the current user ID
        const userId = firebase.auth().currentUser.uid;
        if (!userId) {
            alert('You must be logged in to delete funds.');
            return;
        }
        
        // Reference to the NPS collection
        const npsRef = db.collection('users').doc(userId).collection('nps');
        
        // If this is a single entry, just delete that document
        if (!isMultiple) {
            // Get the document to display details in the confirmation
            const docRef = npsRef.doc(docId);
            const doc = await docRef.get();
            
            if (!doc.exists) {
                alert('NPS scheme not found.');
                return;
            }
            
            const data = doc.data();
            const schemeName = data.scheme_name || 'this scheme';
            const tierLabel = tier === 'tier1' ? 'Tier 1' : 'Tier 2';
            
            // Ask for confirmation
            if (!confirm(`Are you sure you want to delete ${schemeName} (${tierLabel})? This action cannot be undone.`)) {
                return;
            }
            
            // Show loading state
            const buttons = document.querySelectorAll(`.btn-delete-nps[data-id="${docId}"]`);
            buttons.forEach(button => {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';
            });
            
            // Delete the document
            await docRef.delete();
            
            // Show success message
            alert(`Successfully deleted ${schemeName} from your ${tierLabel} investments.`);
        } else {
            // Multiple entries found for this scheme - confirm deletion of all
            // First get the scheme name for better UX
            const tierValue = tier === 'tier1' ? 'tier1' : 'tier2';
            const query = await npsRef.where('scheme_code', '==', schemeCode)
                                    .where('tier', '==', tierValue)
                                    .get();
            
            if (query.empty) {
                alert('No matching schemes found.');
                return;
            }
            
            // Get the scheme name from the first document
            const firstDoc = query.docs[0];
            const schemeName = firstDoc.data().scheme_name || schemeCode;
            const tierLabel = tier === 'tier1' ? 'Tier 1' : 'Tier 2';
            
            // Ask for confirmation - specially formatted for multiple entries
            if (!confirm(`This scheme "${schemeName}" has multiple entries in your ${tierLabel} investments. Do you want to delete ALL entries for this scheme?`)) {
                return;
            }
            
            // Show loading state
            const buttons = document.querySelectorAll(`.btn-delete-nps[data-scheme="${schemeCode}"][data-tier="${tier}"]`);
            buttons.forEach(button => {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';
            });
            
            // Delete all documents in batches (Firestore supports up to 500 operations per batch)
            const batch = db.batch();
            let count = 0;
            
            query.forEach(doc => {
                batch.delete(doc.ref);
                count++;
            });
            
            // Commit the batch delete
            await batch.commit();
            
            // Show success message
            alert(`Successfully deleted all ${count} entries of ${schemeName} from your ${tierLabel} investments.`);
        }
        
        // Update the display
        updateNPSHoldings();
        
    } catch (error) {
        console.error('Error deleting NPS scheme:', error);
        alert(`Error deleting NPS scheme: ${error.message}. Please try again.`);
        
        // Reset buttons in case of error
        const buttons = document.querySelectorAll(`.btn-delete-nps[data-id="${docId}"]`);
        buttons.forEach(button => {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-trash mr-1"></i>Delete';
        });
    }
}

// Make sure our editInvestment function is available globally
// deleteNPS is no longer needed

// Initialize with Tier 1 tab active
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Content loaded - initializing NPS page");
    
    // Activate Tier 1 tab by default
    tier1Tab.click();
    
    // Global variables to store unsubscribe functions
    let npsUnsubscribe = null;
    let metadataUnsubscribe = null;
    
    // Flag to control update scheduling
    let updateScheduled = false;
    let updateTimeout = null;
    
    // Track if initial load has completed
    let initialLoadComplete = false;
    
    // Listen for Firebase auth state changes
    firebase.auth().onAuthStateChanged((user) => {
        console.log("Auth state changed:", user ? "User logged in" : "No user");
        
        // Clean up previous listeners to prevent duplicate events
        if (npsUnsubscribe) {
            console.log("Cleaning up previous NPS listener");
            npsUnsubscribe();
            npsUnsubscribe = null;
        }
        
        if (metadataUnsubscribe) {
            console.log("Cleaning up previous metadata listener");
            metadataUnsubscribe();
            metadataUnsubscribe = null;
        }
        
        // Clear any pending updates
        if (updateTimeout) {
            clearTimeout(updateTimeout);
            updateTimeout = null;
        }
        
        if (user) {
            const userId = user.uid;
            console.log(`Setting up listeners for user: ${userId}`);
            
            // Initialize metadata if needed
            initializeMetadata(userId);
            
            // Important: Do a one-time direct update first instead of waiting for the listener
            // This ensures we have control over the initial data load
            updateNPSHoldings();
            
            // After initial load, set up the listeners for real-time updates
            setTimeout(() => {
            // Set up a listener for NPS holdings with debouncing
            npsUnsubscribe = db.collection('users').doc(userId).collection('nps')
                .onSnapshot((snapshot) => {
                    const changes = snapshot.docChanges();
                    if (changes.length > 0) {
                        console.log(`Holdings updated: ${changes.length} changes`);
                        scheduleUpdate();
                    }
                }, (error) => {
                    console.error("Error in NPS holdings listener:", error);
                });
            
            // Set up a listener for metadata with debouncing
            metadataUnsubscribe = db.collection('users').doc(userId).collection('nps_metadata')
                .onSnapshot((snapshot) => {
                    const changes = snapshot.docChanges();
                    if (changes.length > 0) {
                        console.log(`Metadata updated: ${changes.length} changes`);
                        scheduleUpdate();
                    }
                }, (error) => {
                    console.error("Error in metadata listener:", error);
                });
            }, 1000); // Delay setting up listeners to avoid double-loading
            
            // Helper function to schedule updates with debouncing
            function scheduleUpdate() {
                if (!updateScheduled) {
                    console.log("Scheduling update");
                    updateScheduled = true;
                    
                    // Clear any existing timeout
                    if (updateTimeout) {
                        clearTimeout(updateTimeout);
                    }
                    
                    // Schedule a new update
                    updateTimeout = setTimeout(() => {
                        console.log("Executing scheduled update");
                        updateNPSHoldings();
                        updateScheduled = false;
                        
                        // Mark initial load as complete after first update
                        if (!initialLoadComplete) {
                            initialLoadComplete = true;
                            console.log("Initial load complete");
                        }
                    }, 800); // Longer delay to ensure all changes are processed
                } else {
                    console.log("Update already scheduled, skipping");
                }
            }
        } else {
            console.log("No user logged in, redirecting to login");
            window.location.href = '/login';
        }
    });
});

// Function to initialize metadata documents if they don't exist
async function initializeMetadata(userId) {
    try {
        console.log("Initializing metadata for user:", userId);
        const tier1Ref = db.collection('users').doc(userId).collection('nps_metadata').doc('tier1_total');
        const tier2Ref = db.collection('users').doc(userId).collection('nps_metadata').doc('tier2_total');
        
        const tier1Doc = await tier1Ref.get();
        const tier2Doc = await tier2Ref.get();
        
        // Create tier1 metadata if it doesn't exist
        if (!tier1Doc.exists) {
            console.log("Creating tier1 metadata document");
            await tier1Ref.set({
                totalInvestment: 0,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Create tier2 metadata if it doesn't exist
        if (!tier2Doc.exists) {
            console.log("Creating tier2 metadata document");
            await tier2Ref.set({
                totalInvestment: 0,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        console.log("Metadata initialization complete");
    } catch (error) {
        console.error('Error initializing metadata:', error);
        alert('Error initializing metadata. Please refresh the page and try again.');
    }
}

// Scheme code buttons functionality
document.addEventListener('DOMContentLoaded', () => {
    const schemeCodeBtns = document.querySelectorAll('.scheme-code-btn');
    
    schemeCodeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const code = btn.dataset.code;
            const tier = code.endsWith('0') || code.endsWith('2') || code.endsWith('4') || code.endsWith('6') || code.endsWith('8') ? 2 : 1;
            
            // Set the code in the appropriate tier input
            if (tier === 1) {
                tier1SchemeCode.value = code;
                tier1FetchBtn.click();
                // Switch to Tier 1 tab if not already active
                tier1Tab.click();
            } else {
                tier2SchemeCode.value = code;
                tier2FetchBtn.click();
                // Switch to Tier 2 tab if not already active
                tier2Tab.click();
            }
        });
    });
});

// Event listeners for the add fund buttons
document.getElementById('tier1AddFundBtn').addEventListener('click', () => {
    submitTier1Fund();
});

document.getElementById('tier2AddFundBtn').addEventListener('click', () => {
    submitTier2Fund();
});

// Add refresh button functionality
const refreshNPSBtn = document.getElementById('refreshNPSBtn');

refreshNPSBtn.addEventListener('click', async () => {
    try {
        refreshNPSBtn.disabled = true;
        refreshNPSBtn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Refreshing...
        `;

        const userId = firebase.auth().currentUser?.uid;
        if (!userId) {
            throw new Error('User not authenticated');
        }

        const npsSnapshot = await db.collection('users').doc(userId).collection('nps').get();
        const updatePromises = [];

        for (const doc of npsSnapshot.docs) {
            const nps = doc.data();
            const schemeCode = nps.scheme_code;

            try {
                const response = await fetch(`https://npsnav.in/api/detailed/${schemeCode}`);
                const data = await response.json();
                
                if (!data || !data['NAV']) {
                    console.error(`Invalid data for ${schemeCode}`);
                    continue;
                }

                const currentNav = parseFloat(data['NAV']);
                if (isNaN(currentNav)) {
                    console.error(`Invalid NAV for ${schemeCode}`);
                    continue;
                }

                const currentValue = nps.units * currentNav;

                updatePromises.push(
                    doc.ref.update({
                        current_nav: currentNav,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    })
                );
            } catch (error) {
                console.error(`Error updating ${schemeCode}:`, error);
            }
        }

        await Promise.all(updatePromises);
        updateNPSHoldings();
        
        refreshNPSBtn.disabled = false;
        refreshNPSBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh NAV
        `;
        
        alert('NPS NAVs updated successfully!');
    } catch (error) {
        console.error('Error refreshing NPS NAVs:', error);
        alert('Error refreshing NPS NAVs. Please try again.');
        refreshNPSBtn.disabled = false;
        refreshNPSBtn.innerHTML = `
            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh NAV
        `;
    }
});

// Update the updateSummary function to use correct element IDs
function updateSummary() {
    const tier1Total = tier1Holdings.reduce((sum, holding) => sum + (holding.investedAmount || 0), 0);
    const tier2Total = tier2Holdings.reduce((sum, holding) => sum + (holding.investedAmount || 0), 0);
    const totalInvestment = tier1Total + tier2Total;
    
    const tier1Current = tier1Holdings.reduce((sum, holding) => sum + (holding.currentValue || 0), 0);
    const tier2Current = tier2Holdings.reduce((sum, holding) => sum + (holding.currentValue || 0), 0);
    const currentValue = tier1Current + tier2Current;
    
    const totalReturns = currentValue - totalInvestment;
    
    // Add animation classes
    document.getElementById('totalNPSInvestment').classList.add('animate-number');
    document.getElementById('currentNPSValue').classList.add('animate-number');
    document.getElementById('totalNPSReturns').classList.add('animate-number');
    
    // Update values with animation
    animateValue('totalNPSInvestment', totalInvestment.toFixed(2));
    animateValue('currentNPSValue', currentValue.toFixed(2));
    animateValue('totalNPSReturns', totalReturns.toFixed(2));
    
    // Remove animation classes after animation completes
    setTimeout(() => {
        document.getElementById('totalNPSInvestment').classList.remove('animate-number');
        document.getElementById('currentNPSValue').classList.remove('animate-number');
        document.getElementById('totalNPSReturns').classList.remove('animate-number');
    }, 1000);
}

// Function to format number in Indian format
function formatIndianNumber(num) {
    const numStr = num.toString();
    const [wholePart, decimalPart] = numStr.split('.');
    const lastThree = wholePart.substring(wholePart.length - 3);
    const otherNumbers = wholePart.substring(0, wholePart.length - 3);
    const formatted = otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + (otherNumbers ? "," : "") + lastThree;
    return decimalPart ? formatted + "." + decimalPart : formatted;
}

// Remove view toggle functionality since we're not using it anymore
document.addEventListener('DOMContentLoaded', () => {
    // ... existing DOMContentLoaded code ...
    
    // Remove view toggle event listeners
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    viewToggleBtns.forEach(btn => {
        btn.remove();
    });
});

// ... rest of the existing code ...

// Add toggle functionality for tier summaries
document.addEventListener('DOMContentLoaded', () => {
    // Tier 1 Toggle
    const tier1Toggle = document.getElementById('tier1Toggle');
    const tier1Details = document.getElementById('tier1Details');
    
    tier1Toggle.addEventListener('change', () => {
        if (tier1Toggle.checked) {
            tier1Details.classList.remove('hidden');
            tier1Details.classList.add('animate-fade-in');
            setTimeout(() => {
                tier1Details.classList.remove('animate-fade-in');
            }, 300);
        } else {
            tier1Details.classList.add('animate-fade-out');
            setTimeout(() => {
                tier1Details.classList.add('hidden');
                tier1Details.classList.remove('animate-fade-out');
            }, 300);
        }
    });
    
    // Tier 2 Toggle
    const tier2Toggle = document.getElementById('tier2Toggle');
    const tier2Details = document.getElementById('tier2Details');
    
    tier2Toggle.addEventListener('change', () => {
        if (tier2Toggle.checked) {
            tier2Details.classList.remove('hidden');
            tier2Details.classList.add('animate-fade-in');
            setTimeout(() => {
                tier2Details.classList.remove('animate-fade-in');
            }, 300);
        } else {
            tier2Details.classList.add('animate-fade-out');
            setTimeout(() => {
                tier2Details.classList.add('hidden');
                tier2Details.classList.remove('animate-fade-out');
            }, 300);
        }
    });
});

// Add these styles to your existing styles
const styles = `
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }
    
    .animate-fade-out {
        animation: fadeOut 0.3s ease-out forwards;
    }
    
    .tier-summary-card {
        transition: all 0.3s ease;
    }
    
    .tier-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .tier-summary-item {
        transition: all 0.3s ease;
    }
    
    .tier-summary-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
`;

// Add the styles to the document
const styleSheet = document.createElement("style");
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

// ... rest of your existing script code ...

// Toggle Tier 1 Form
document.addEventListener('DOMContentLoaded', function() {
    // Toggle Tier 1 Form
    const tier1FormToggle = document.getElementById('tier1FormToggle');
    const tier1FormContainer = document.getElementById('tier1FormContainer');
    const tier1FormToggleIcon = document.getElementById('tier1FormToggleIcon');
    const tier1FormToggleText = document.getElementById('tier1FormToggleText');
    
    tier1FormToggle.addEventListener('click', function() {
        const isVisible = !tier1FormContainer.classList.contains('hidden');
        
        if (isVisible) {
            tier1FormContainer.classList.add('hidden');
            tier1FormToggleIcon.classList.remove('fa-chevron-up');
            tier1FormToggleIcon.classList.add('fa-chevron-down');
            tier1FormToggleText.textContent = 'Show';
        } else {
            tier1FormContainer.classList.remove('hidden');
            tier1FormToggleIcon.classList.remove('fa-chevron-down');
            tier1FormToggleIcon.classList.add('fa-chevron-up');
            tier1FormToggleText.textContent = 'Hide';
        }
    });
    
    // Toggle Tier 2 Form
    const tier2FormToggle = document.getElementById('tier2FormToggle');
    const tier2FormContainer = document.getElementById('tier2FormContainer');
    const tier2FormToggleIcon = document.getElementById('tier2FormToggleIcon');
    const tier2FormToggleText = document.getElementById('tier2FormToggleText');
    
    tier2FormToggle.addEventListener('click', function() {
        const isVisible = !tier2FormContainer.classList.contains('hidden');
        
        if (isVisible) {
            tier2FormContainer.classList.add('hidden');
            tier2FormToggleIcon.classList.remove('fa-chevron-up');
            tier2FormToggleIcon.classList.add('fa-chevron-down');
            tier2FormToggleText.textContent = 'Show';
        } else {
            tier2FormContainer.classList.remove('hidden');
            tier2FormToggleIcon.classList.remove('fa-chevron-down');
            tier2FormToggleIcon.classList.add('fa-chevron-up');
            tier2FormToggleText.textContent = 'Hide';
        }
    });

    // ... existing code ...
});

// ... existing code ...

// Mobile toggle functionality
document.addEventListener('DOMContentLoaded', function() {
    // Toggle Tier 1 Form
    // ... existing code for form toggles ...
    
    // Mobile toggle for Tier 1 holdings
    const tier1MobileToggle = document.getElementById('tier1MobileToggle');
    const tier1MobileHoldings = document.getElementById('tier1MobileHoldings');
    const tier1ToggleIcon = document.getElementById('tier1ToggleIcon');
    const tier1ToggleText = document.getElementById('tier1ToggleText');
    
    if (tier1MobileToggle) {
        tier1MobileToggle.addEventListener('click', function() {
            const isVisible = !tier1MobileHoldings.classList.contains('hidden');
            
            if (isVisible) {
                tier1MobileHoldings.classList.add('hidden');
                tier1ToggleIcon.classList.remove('fa-chevron-up');
                tier1ToggleIcon.classList.add('fa-chevron-down');
                tier1ToggleText.textContent = 'Show';
            } else {
                tier1MobileHoldings.classList.remove('hidden');
                tier1ToggleIcon.classList.remove('fa-chevron-down');
                tier1ToggleIcon.classList.add('fa-chevron-up');
                tier1ToggleText.textContent = 'Hide';
            }
        });
    }
    
    // Mobile toggle for Tier 2 holdings
    const tier2MobileToggle = document.getElementById('tier2MobileToggle');
    const tier2MobileHoldings = document.getElementById('tier2MobileHoldings');
    const tier2ToggleIcon = document.getElementById('tier2ToggleIcon');
    const tier2ToggleText = document.getElementById('tier2ToggleText');
    
    if (tier2MobileToggle) {
        tier2MobileToggle.addEventListener('click', function() {
            const isVisible = !tier2MobileHoldings.classList.contains('hidden');
            
            if (isVisible) {
                tier2MobileHoldings.classList.add('hidden');
                tier2ToggleIcon.classList.remove('fa-chevron-up');
                tier2ToggleIcon.classList.add('fa-chevron-down');
                tier2ToggleText.textContent = 'Show';
            } else {
                tier2MobileHoldings.classList.remove('hidden');
                tier2ToggleIcon.classList.remove('fa-chevron-down');
                tier2ToggleIcon.classList.add('fa-chevron-up');
                tier2ToggleText.textContent = 'Hide';
            }
        });
    }
    
    // Ensure proper tab switching also handles mobile views
    tier1Tab.addEventListener('click', function() {
        // If mobile holdings are visible in tier 2, hide them when switching to tier 1
        if (tier2MobileHoldings && !tier2MobileHoldings.classList.contains('hidden')) {
            tier2MobileHoldings.classList.add('hidden');
            if (tier2ToggleIcon) {
                tier2ToggleIcon.classList.remove('fa-chevron-up');
                tier2ToggleIcon.classList.add('fa-chevron-down');
            }
            if (tier2ToggleText) {
                tier2ToggleText.textContent = 'Show';
            }
        }
    });
    
    tier2Tab.addEventListener('click', function() {
        // If mobile holdings are visible in tier 1, hide them when switching to tier 2
        if (tier1MobileHoldings && !tier1MobileHoldings.classList.contains('hidden')) {
            tier1MobileHoldings.classList.add('hidden');
            if (tier1ToggleIcon) {
                tier1ToggleIcon.classList.remove('fa-chevron-up');
                tier1ToggleIcon.classList.add('fa-chevron-down');
            }
            if (tier1ToggleText) {
                tier1ToggleText.textContent = 'Show';
            }
        }
    });
    
    // ... rest of existing DOMContentLoaded code ...
});

// Modify the function that generates mobile cards to add enhanced styling
// This is inside updateNPSHoldings function, where it generates the mobile cards
// ...

// Generate mobile card with better styling
// This code appears twice - once for tier1 and once for tier2, update both instances
/*
const card = document.createElement('div');
card.className = 'nps-mobile-card';
card.innerHTML = `
    <div class="nps-mobile-card-content">
        <div class="nps-mobile-card-header">
            <h4 class="nps-mobile-card-title">${holding.scheme_name}</h4>
            <div class="text-xs text-indigo-600 font-medium">${schemeCode}</div>
        </div>
        <div class="nps-mobile-card-details">
            <div class="nps-mobile-card-item">
                <span class="nps-mobile-card-label">Current NAV</span>
                <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.current_nav.toFixed(2))}</span>
            </div>
            <div class="nps-mobile-card-item">
                <span class="nps-mobile-card-label">Units</span>
                <span class="nps-mobile-card-value">${formatIndianNumber(holding.units.toFixed(2))}</span>
            </div>
            <div class="nps-mobile-card-item">
                <span class="nps-mobile-card-label">Current Value</span>
                <span class="nps-mobile-card-value">₹${formatIndianNumber(holding.currentValue.toFixed(2))}</span>
            </div>
        </div>
        <div class="nps-mobile-card-actions">
            <button class="btn-edit-nps text-blue-600 hover:text-blue-900 mr-2 px-3 py-1 rounded-md hover:bg-blue-50" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-units="${holding.units}" data-multiple="false">
                <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button class="btn-delete-nps text-red-600 hover:text-red-900 px-3 py-1 rounded-md hover:bg-red-50" data-id="${holding.docId}" data-tier="tier1" data-scheme="${schemeCode}" data-multiple="false">
                <i class="fas fa-trash mr-1"></i>Delete
            </button>
        </div>
    </div>
`;
*/

// ... existing code ...
</script>

<!-- ... existing code ...
</script>
{% endblock %}